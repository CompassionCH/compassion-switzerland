<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <data>
        <!-- This templates creates the view "Write a letter". It receives the following arguments: -->
        <!--     1. child, the selected child to write a letter to -->
        <!--     2. template_id, the selected template to write the letter on -->
        <!--     3. children, The list of children for the partner -->
        <!--     4. templates, The proposed templates of the database -->
        <template id="letter_page_template" name="Write a letter">
            <t t-set="selected" t-value="'letter'"/>
            <t t-set="title">Write a letter | <t t-esc="partner.company_id.address_name"/></t>
            <t t-call="website_compassion.my_account_layout">
                <t t-call="website_compassion.letter_horizontal_pictures"/>

                <div class="container-fluid pr-5 pl-5 mb-5 mt-4">
                    <div class="row">
                        <div class="col-md-4">
                            <t t-call="website_compassion.letter_templates"/>
                        </div>

                        <div class="col-md-4">
                            <t t-call="website_compassion.letter_text_content"/>
                        </div>

                        <div class="col-md-4">
                            <t t-call="website_compassion.letter_actions"/>
                        </div>
                    </div>
                </div>
            </t>
            <script type="text/javascript" src="/website_compassion/static/src/js/my_account.js"/>
            <script type="text/javascript" src="/website_compassion/static/src/js/write_a_letter.js"/>
        </template>

        <!-- Children pictures at the top of the view -->
        <template id="letter_horizontal_pictures">
            <h3 class="text-primary text-center text-uppercase my-5">I want to write to:</h3>
            <t t-set="javascript_hook">selectElement</t>
            <t t-set="javascript_param">child</t>
            <t t-call="website_compassion.children_horizontal_cards"/>
        </template>

        <!-- Here are displayed all the available templates to write a letter -->
        <template id="letter_templates">
            <h3 class="text-primary text-center text-uppercase mb-4">Choose a template</h3>
            <ul class="templates nav nav-tabs" style="height: 33rem; overflow-y: scroll">
                <t t-foreach="templates" t-as="template">
                    <div class="w-50 p-2">
                        <div t-attf-id="card_template_{{template.id}}" t-attf-onclick="selectElement('{{template.id}}', 'template')" class="card card-clickable text-center">
                            <li>
                                <t t-if="template.id == template_id.id">
                                    <img t-attf-id="template_{{template.id}}" t-att-name="template.name" class="template-image border border-5 border-primary" t-att-src="template.template_image_url" alt="Template image" style="width: 95%; height: auto;"/>
                                </t>
                                <t t-else="">
                                    <img t-attf-id="template_{{template.id}}" t-att-name="template.name" class="template-image" t-att-src="template.template_image_url" alt="Template image" style="width: 95%; height: auto;"/>
                                </t>
                                <span t-attf-id="template_name_{{template.id}}"  style="display: none;"><t t-esc="template.name"/></span>
                            </li>
                        </div>
                    </div>
                </t>
            </ul>
        </template>

        <!-- Display the text box to write the content of the letter -->
        <template id="letter_text_content">
            <h3 class="text-primary text-center text-uppercase mb-4">Write your text</h3>
            <div class="modal fade" id="guidelines-modal" tabindex="-1" role="dialog" aria-labelledby="guidelines-label" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="guidelines-label">Writing guidelines</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&amp;times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <h5>What can I write?</h5>
                      <ul>
                        <li>Encourage your sponsored child</li>
                        <li>Choose one topic per letter</li>
                        <li>Ask questions about his or her dreams for the future</li>
                        <li>Tell simple stories about your life, your village or town, your hobbies, your work and your family</li>
                        <li>Share a bible story that you like</li>
                    </ul>
                      <h5>What should I avoid?</h5>
                      <p>Please never mention:</p>
                      <ul>
                        <li>Your postal address</li>
                        <li>Your e-mail address</li>
                        <li>Your phone number</li>
                        <li>The address of Compassion Switzerland</li>
                        <li>Your social media contact (Facebook or other platforms)</li>
                        <li>Don't make any promise about a gift or a visit</li>
                    </ul>
                      <h5>How to send a physical letter?</h5>
                      <ul>

                        <li><a id="link_to_print" t-attf-onclick="downloadLetter()" style="color:blue;cursor: pointer; cursor: hand;">Print the labels paper</a> and stick them on any piece of paper, card, attachment.</li>
                          <li>Send your letter to Compassion Switzerland, Rue Galil√©e 3, 1400 Yverdon-les-Bains.</li>
                    </ul>
                  </div>
              </div>
            </div>
            </div>
            <div class="w-100x">
                <a class="btn btn-primary mb-2" data-toggle="modal" data-target="#guidelines-modal">
                    <span style="color: white">Quick guidelines</span>
                </a>
                <t t-set="help_link">https://compassion.ch/de/was-soll-ich-meinem-patenkind-schreiben/</t>
                <a class="btn btn-primary mb-2" t-att-href="help_link" target="_blank">
                    <span>What should I write?</span>
                </a>
                <t t-set="letter_travel_link">https://compassion.ch/le-voyage-de-vos-lettres</t>
                <a class="btn btn-primary mb-2" t-att-href="letter_travel_link" target="_blank">
                    <span>What happens to my letter?</span>
                </a>
            </div>
            <t t-set="placeholder">Write your text here...</t>
            <textarea id="letter_content" class="w-100" t-att-placeholder="placeholder" style="height: 30rem; resize: none;"/>
        </template>

        <!-- Menu of available actions to do with you letter (image loading, preview, send, ...) -->
        <template id="letter_actions">
            <h3 class="text-primary text-center text-uppercase mb-4">Add a picture</h3>
            <input id="file_selector" type="file" accept="image/*" style="display: none;"/>
            <button class="btn btn-primary w-100 mb-2" onclick="document.getElementById('file_selector').click();">
                <span>Add image</span>
            </button>
            <!-- TODO CI-765: Use this warning when no image was added to list -->
            <div id="letter_images_duplicated" class="alert alert-info alert-dismissable text-center ml-2 mt-2 mb-2" style="display: none;">
                The images that are selected multiple times are ignored
            </div>

            <!-- Filled with javascript -->
            <!-- TODO CI-765: Change overflow-y to scroll so that images are not resized once the element become scrollable -->
            <ul id="image_display_table" class="templates w-100 nav d-block border border-gray" style="max-height: 18rem; overflow-y:auto;"/>
            <span id="child_id" t-esc="child_id.id" style="display: none;"/>
            <span id="child_name" t-esc="child_id.name" style="display: none;"/>
            <span id="child_local_id" t-esc="child_id.local_id" style="display: none;"/>
            <span id="template_id" t-esc="template_id.id" style="display: none;"/>
            <span id="template_name" t-esc="template_id.name" style="display: none;"/>

            <h3 class="text-primary text-center text-uppercase mt-5 mb-4">Send your letter</h3>
            <button id="preview_normal" class="btn btn-primary w-100 mb-2" t-attf-onclick="createLetter(preview=true)">
                Preview
            </button>
            <button id="preview_loading" class="btn btn-primary w-100 mt-2 mb-2" type="button" disabled="true" style="display: none;">
                <span class="spinner-border spinner-border-sm" role="status"/>
                Creation...
            </button>
            <div id="letter_sent_correctly" class="alert alert-success alert-dismissable text-center ml-2 mt-2 mb-2" style="display: none;">
                Your letter was correctly sent ! Thank you for writing
            </div>
            <div id="letter_error" class="alert alert-danger alert-dismissable text-center ml-2 mt-2 mb-2" style="display: none;">
                There was an error while submitting your letter. Please copy your text to make sure you won't lose it and contact us for signaling the issue.
            </div>
            <div id="preview_error" class="alert alert-danger alert-dismissable text-center ml-2 mt-2 mb-2" style="display: none;">
                There was an error while rendering the preview. Make sure you entered some text and that your attachments are valid. Please contact us if you experience unexpected behaviours.
            </div>
            <button id="sending_normal" class="btn btn-primary w-100" t-attf-onclick="sendLetter('{{request.env.user.partner_id.firstname}}')">
                Send
            </button>
            <button id="sending_loading" class="btn btn-primary w-100" type="button" disabled="true" style="display: none;">
                <span class="spinner-border spinner-border-sm" role="status"/>
                Sending...
            </button>
        </template>
    </data>
</odoo>
